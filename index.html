<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SXCCE CALC</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-day: linear-gradient(135deg,#e3eefc,#f7fbff);
      --bg-night: linear-gradient(135deg,#0f1724,#071028);
      --card-day: #ffffff;
      --card-night: #0b1220;
      --text-day: #0a3d62;
      --text-night: #d1e7ff;
      --muted-day: #6b7280;
      --muted-night: #9aaed3;
    }

    html,body { height:100%; }
    body {
      font-family: 'Poppins', sans-serif;
      margin:0;
      padding-bottom:40px;
      background: var(--bg-day);
      color: var(--text-day);
      transition: background .35s ease, color .35s ease;
    }

    body.dark {
      background: var(--bg-night);
      color: var(--text-night);
    }

    .container-box {
      max-width: 820px;
      margin: 34px auto;
      background: var(--card-day);
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 8px 30px rgba(12, 20, 40, 0.08);
      transition: background .35s ease, box-shadow .35s ease;
      transform: translateY(12px);
      animation: fadeUp .6s ease both;
    }
    body.dark .container-box {
      background: var(--card-night);
      box-shadow: 0 12px 40px rgba(2,6,23,0.6);
    }

    @keyframes fadeUp {
      from { opacity:0; transform: translateY(24px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .app-title {
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }
    .title-left { display:flex; flex-direction:column; }
    .title-main { font-size:28px; font-weight:800; letter-spacing:1px; margin:0; }
    .title-sub { margin:0; font-size:13px; color:var(--muted-day); }
    body.dark .title-sub { color: var(--muted-night); }

    .founder { margin-top:6px; font-size:13px; color:var(--muted-day); }
    body.dark .founder { color: var(--muted-night); }

    .settings-btn { background:transparent; border:none; font-size:18px; color:var(--muted-day); cursor:pointer; padding:6px 8px; border-radius:8px; transition: all .15s ease; }
    .settings-btn:hover { transform:translateY(-2px); }
    body.dark .settings-btn { color: var(--muted-night); }

    label { font-weight:600; }
    .result-box {
      background: rgba(11,105,255,0.06);
      border-left:4px solid #0a66c2;
      padding:14px;
      border-radius:10px;
      margin-top:14px;
      transition: transform .25s ease;
    }
    body.dark .result-box { background: rgba(255,255,255,0.03); border-left:4px solid rgba(111,66,193,0.9); }

    .history-modal-list { max-height: 52vh; overflow:auto; padding-right:6px; }

    .muted { color:var(--muted-day); }
    body.dark .muted { color:var(--muted-night); }

    @media (max-width:576px){
      .title-main{ font-size:22px; }
      .container-box { padding:16px; margin:18px; }
    }

    .subject-fade { transition: opacity .28s ease, transform .28s ease; }
    .btn-ghost { background: transparent; border: 1px solid rgba(15,23,42,0.06); }
    body.dark .btn-ghost { border-color: rgba(255,255,255,0.06); color: var(--text-night); }

    footer { text-align:center; margin-top:12px; color:var(--muted-day); font-size:13px; }
    body.dark footer { color:var(--muted-night); }

    .history-item { padding:10px; border-radius:8px; transition: background .15s ease, transform .12s ease; border: 1px solid rgba(0,0,0,0.03); margin-bottom:8px; }
    .history-item .meta { color:var(--muted-day); font-size:12px; }
    body.dark .history-item { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.03); }
    body.dark .history-item .meta { color: var(--muted-night); }
  </style>
</head>
<body>

  <div class="container container-box">

    <!-- HEADER -->
    <div class="app-title mb-3">
      <div class="title-left">
        <h1 class="title-main subject-fade" id="subjectTitle">SXCCE <span style="margin-left:8px">CALC</span></h1>
        <div class="founder muted">Founded by RIJO SREEJITH</div>
      </div>

      <div class="d-flex align-items-start gap-2">
        <button class="settings-btn" id="openSettingsBtn" title="Settings" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
            <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.094.32a1.464 1.464 0 0 1-2.105.872l-.292-.16c-1.22-.66-2.58.482-1.91 1.701l.159.292a1.464 1.464 0 0 1-.872 2.105l-.32.094c-1.4.413-1.4 2.397 0 2.81l.32.094a1.464 1.464 0 0 1 .872 2.105l-.159.292c-.67 1.22.69 2.36 1.91 1.701l.292-.16a1.464 1.464 0 0 1 2.105.872l.094.32c.413 1.4 2.397 1.4 2.81 0l.094-.32a1.464 1.464 0 0 1 2.105-.872l.292.16c1.22.66 2.58-.482 1.91-1.701l-.159-.292a1.464 1.464 0 0 1 .872-2.105l.32-.094c1.4-.413 1.4-2.397 0-2.81l-.32-.094a1.464 1.464 0 0 1-.872-2.105l.159-.292c.67-1.22-.69-2.36-1.91-1.701l-.292.16a1.464 1.464 0 0 1-2.105-.872l-.094-.32z"/>
            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Subject select & main form -->
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="fw-semibold">Select Subject</label>
        <select id="subjectSelect" class="form-select" onchange="updateTitle();">
          <option>Tamil</option>
          <option>English</option>
          <option>Maths</option>
          <option>Physics</option>
          <option>Chemistry</option>
          <option>Computer</option>
        </select>
      </div>

      <div class="col-12 col-md-6 d-flex align-items-end">
        <div class="w-100 text-md-end mt-2 mt-md-0 muted">Your results appear below — history stored in Settings.</div>
      </div>

      <div class="col-12 col-md-6">
        <label class="fw-semibold">Assignment 1 (out of 100)</label>
        <input id="a1" type="number" class="form-control" min="0" max="100" placeholder="e.g., 78">
      </div>

      <div class="col-12 col-md-6">
        <label class="fw-semibold">Internal Exam 1 (out of 100)</label>
        <input id="i1" type="number" class="form-control" min="0" max="100" placeholder="e.g., 64">
      </div>

      <div class="col-12 col-md-6">
        <label class="fw-semibold">Assignment 2 (out of 100)</label>
        <input id="a2" type="number" class="form-control" min="0" max="100" placeholder="e.g., 82">
      </div>

      <div class="col-12 col-md-6">
        <label class="fw-semibold">Internal Exam 2 (out of 100)</label>
        <input id="i2" type="number" class="form-control" min="0" max="100" placeholder="e.g., 70">
      </div>

      <div class="col-12">
        <label class="fw-semibold">Semester Exam (out of 100 → converted to 60)</label>
        <input id="sem" type="number" class="form-control" min="0" max="100" placeholder="e.g., 75">
      </div>

      <div class="col-12 d-flex gap-2">
        <button id="calcBtn" class="btn btn-primary flex-grow-1" onclick="calculateMarks()">Calculate Marks</button>
        <button id="resetBtn" class="btn btn-outline-secondary" onclick="resetForm()">Reset</button>
      </div>
    </div>

    <!-- RESULTS (homepage) -->
    <div class="row mt-4">
      <div class="col-12">
        <div id="results" class="result-box" style="display:none">
          <h5 id="resultSubject"></h5>
          <div id="r1"></div>
          <div id="r2"></div>
          <div id="r3"></div>
          <div id="r4"></div>
          <div id="r5"></div>
          <div id="r6"></div>
          <div id="r7" class="fw-bold mt-2"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- footer (also with founder text per Option D) -->
  <footer>
    Founded by RIJO SREEJITH — SXCCE CALC © <span id="year"></span>
  </footer>

  <!-- SETTINGS OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsLabel">
    <div class="offcanvas-header">
      <h5 id="settingsLabel">Settings</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

      <!-- Theme -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Theme</label>
        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-outline-primary" id="dayBtn">Day</button>
          <button class="btn btn-outline-dark" id="nightBtn">Night</button>
        </div>
        <div class="form-text muted">Switch page theme (saved).</div>
      </div>

      <hr>

      <!-- History -->
      <div class="mb-3">
        <label class="form-label fw-semibold">History</label>
        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-primary" id="openHistoryBtn">Open History</button>
          <button class="btn btn-outline-secondary" id="exportHistoryBtn">Export CSV</button>
        </div>
        <div class="form-text muted">Open saved calculations and filter by subject.</div>
      </div>

      <hr>

      <!-- Login / Logout -->
      <div>
        <label class="form-label fw-semibold">Login / Student</label>
        <div id="loginArea"></div>
        <div class="form-text muted">Sign in to save student name & roll (local only).</div>
      </div>

    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">SXCCE</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Student Name</label>
          <input id="studentName" class="form-control mb-2" placeholder="e.g., Raju">

          <label class="form-label">Roll Number</label>
          <input id="studentRoll" class="form-control mb-2" placeholder="e.g., 21CS001">

          <div class="d-flex justify-content-end mt-2">
            <button id="saveLoginBtn" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY MODAL (opened from Settings) -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex gap-2 mb-3 align-items-center">
            <label class="mb-0 fw-semibold">Filter by Subject</label>
            <select id="historySubjectFilter" class="form-select w-auto">
              <option value="All">All</option>
              <option value="Tamil">Tamil</option>
              <option value="English">English</option>
              <option value="Maths">Maths</option>
              <option value="Physics">Physics</option>
              <option value="Chemistry">Chemistry</option>
              <option value="Computer">Computer</option>
            </select>
            <div class="ms-auto">
              <button class="btn btn-sm btn-danger" id="clearAllHistoryBtn">Clear History</button>
            </div>
          </div>

          <div id="historyList" class="history-modal-list"></div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- state ----------
    const state = {
      theme: localStorage.getItem('sx_theme') || 'day',
      user: JSON.parse(localStorage.getItem('sx_user') || 'null'),
      history: JSON.parse(localStorage.getItem('sx_calc_history') || '[]'),
    };

    // elements
    const body = document.body;
    const subjectTitle = document.getElementById('subjectTitle');
    const subjectSelect = document.getElementById('subjectSelect');

    const resultsCard = document.getElementById('results');
    const resultSubject = document.getElementById('resultSubject');

    // fill year
    document.getElementById('year').textContent = new Date().getFullYear();

    // apply theme
    function applyTheme(){
      if(state.theme === 'night') body.classList.add('dark'); else body.classList.remove('dark');
    }

    // init theme buttons
    document.getElementById('dayBtn').addEventListener('click', ()=>{
      state.theme = 'day'; localStorage.setItem('sx_theme', state.theme); applyTheme();
    });
    document.getElementById('nightBtn').addEventListener('click', ()=>{
      state.theme = 'night'; localStorage.setItem('sx_theme', state.theme); applyTheme();
    });

    // update title
    function updateTitle(){
      const subject = subjectSelect.value;
      subjectTitle.style.opacity = 0;
      setTimeout(()=> {
        subjectTitle.innerHTML = `SXCCE <span style="margin-left:8px">CALC</span> - ${escapeHtml(subject)}`;
        subjectTitle.style.opacity = 1;
      }, 180);
    }

    // ---------- login UI ----------
    function renderLoginArea(){
      const loginArea = document.getElementById('loginArea');
      if(state.user){
        loginArea.innerHTML = `
          <div class="mb-2">
            <div><strong>${escapeHtml(state.user.name)}</strong></div>
            <div class="muted">Roll: ${escapeHtml(state.user.roll)}</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" id="editLoginBtn">Edit</button>
            <button class="btn btn-sm btn-danger" id="logoutBtn">Logout</button>
          </div>`;
        document.getElementById('editLoginBtn').addEventListener('click', ()=>{
          document.getElementById('studentName').value = state.user.name;
          document.getElementById('studentRoll').value = state.user.roll;
          const modal = new bootstrap.Modal(document.getElementById('loginModal'));
          modal.show();
        });
        document.getElementById('logoutBtn').addEventListener('click', ()=>{
          if(confirm('Logout?')){
            state.user = null;
            localStorage.removeItem('sx_user');
            renderLoginArea();
            renderUserBadge();
          }
        });
      } else {
        loginArea.innerHTML = `<button class="btn btn-primary" id="openLoginBtn">Login</button>`;
        document.getElementById('openLoginBtn').addEventListener('click', ()=>{
          document.getElementById('studentName').value = '';
          document.getElementById('studentRoll').value = '';
          const modal = new bootstrap.Modal(document.getElementById('loginModal'));
          modal.show();
        });
      }
    }

    // save login
    document.getElementById('saveLoginBtn').addEventListener('click', ()=>{
      const name = document.getElementById('studentName').value.trim();
      const roll = document.getElementById('studentRoll').value.trim();
      if(!name || !roll){ alert('Please enter both student name and roll number.'); return; }
      state.user = { name, roll };
      localStorage.setItem('sx_user', JSON.stringify(state.user));
      const modalEl = document.getElementById('loginModal');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();
      renderLoginArea();
      renderUserBadge();
    });

    function renderUserBadge(){
      const existing = document.querySelector('.user-badge-inline');
      if(state.user){
        if(existing) existing.remove();
        const div = document.createElement('div');
        div.className = 'user-badge-inline muted mt-2';
        div.innerHTML = `Student: <strong>${escapeHtml(state.user.name)}</strong> &nbsp; | &nbsp; Roll: <strong>${escapeHtml(state.user.roll)}</strong>`;
        document.querySelector('.title-left').appendChild(div);
      } else {
        if(existing) existing.remove();
      }
    }

    // ---------- calculation logic ----------
    function clamp(v){ v = Number(v); if(isNaN(v)) return NaN; return Math.max(0, Math.min(100, v)); }
    function format(n){ return Number(n).toFixed(2); }
    function escapeHtml(text){ if(!text) return ''; return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }

    function calculateMarks(){
      const a1 = clamp(document.getElementById('a1').value);
      const a2 = clamp(document.getElementById('a2').value);
      const i1 = clamp(document.getElementById('i1').value);
      const i2 = clamp(document.getElementById('i2').value);
      const sem = clamp(document.getElementById('sem').value);

      if([a1,a2,i1,i2,sem].some(v=>isNaN(v))){
        alert('Please enter all fields (0 - 100).');
        return;
      }

      const a1c = (a1/100) * 20;
      const a2c = (a2/100) * 20;
      const i1c = (i1/100) * 30;
      const i2c = (i2/100) * 30;

      const internalSumRaw = a1c + a2c + i1c + i2c;
      const internal40 = (internalSumRaw / 100) * 40;
      const sem60 = (sem / 100) * 60;
      const finalTotal = internal40 + sem60;

      const subject = subjectSelect.value;

      resultSubject.innerHTML = `${escapeHtml(subject)} - Result`;
      document.getElementById('r1').innerHTML = `Assignment 1 (20): <b>${format(a1c)}</b>`;
      document.getElementById('r2').innerHTML = `Internal 1 (30): <b>${format(i1c)}</b>`;
      document.getElementById('r3').innerHTML = `Assignment 2 (20): <b>${format(a2c)}</b>`;
      document.getElementById('r4').innerHTML = `Internal 2 (30): <b>${format(i2c)}</b>`;
      document.getElementById('r5').innerHTML = `Internal Total (converted to 40): <b>${format(internal40)}</b>`;
      document.getElementById('r6').innerHTML = `Semester Exam (converted to 60): <b>${format(sem60)}</b>`;
      document.getElementById('r7').innerHTML = `Final Total (100): <b>${format(finalTotal)}</b>`;

      resultsCard.style.display = 'block';

      // save into history
      const rec = {
        id: Date.now(),
        subject,
        inputs: { a1,a2,i1,i2,sem },
        outputs: { a1c,a2c,i1c,i2c,internal40,sem60,finalTotal },
        time: new Date().toISOString(),
        user: state.user ? {...state.user} : null
      };
      state.history.unshift(rec);
      if(state.history.length > 300) state.history.pop();
      localStorage.setItem('sx_calc_history', JSON.stringify(state.history));
    }

    function resetForm(){
      document.getElementById('a1').value = '';
      document.getElementById('a2').value = '';
      document.getElementById('i1').value = '';
      document.getElementById('i2').value = '';
      document.getElementById('sem').value = '';
      resultsCard.style.display = 'none';
    }

    // ---------- History modal logic ----------
    const historyModalEl = document.getElementById('historyModal');
    const historyModal = new bootstrap.Modal(historyModalEl);

    document.getElementById('openHistoryBtn').addEventListener('click', ()=>{
      renderHistoryList();
      historyModal.show();
    });

    document.getElementById('historySubjectFilter').addEventListener('change', renderHistoryList);

    function renderHistoryList(){
      const listEl = document.getElementById('historyList');
      listEl.innerHTML = '';
      const filter = document.getElementById('historySubjectFilter').value;
      const items = state.history.filter(h => (filter === 'All') ? true : (h.subject === filter));
      if(items.length === 0){
        listEl.innerHTML = '<div class="muted">No history for this filter.</div>';
        return;
      }
      items.forEach(h => {
        const div = document.createElement('div');
        div.className = 'history-item';
        const time = new Date(h.time).toLocaleString();
        const userPart = h.user ? `<div class="meta">Student: ${escapeHtml(h.user.name)} | Roll: ${escapeHtml(h.user.roll)}</div>` : '';
        div.innerHTML = `
          <div class="d-flex justify-content-between">
            <div>
              <div><strong>${escapeHtml(h.subject)}</strong> — <span class="muted small">${time}</span></div>
              ${userPart}
              <div class="mt-2">Total: <strong>${format(h.outputs.finalTotal)}</strong> / 100</div>
            </div>
            <div class="text-end">
              <button class="btn btn-sm btn-outline-primary mb-1" onclick="reapplyHistory(${h.id})">Reapply</button>
              <button class="btn btn-sm btn-danger" onclick="deleteHistoryItem(${h.id})">Delete</button>
            </div>
          </div>`;
        listEl.appendChild(div);
      });
    }

    function reapplyHistory(id){
      const rec = state.history.find(x => x.id === id);
      if(!rec) return;
      document.getElementById('a1').value = rec.inputs.a1;
      document.getElementById('a2').value = rec.inputs.a2;
      document.getElementById('i1').value = rec.inputs.i1;
      document.getElementById('i2').value = rec.inputs.i2;
      document.getElementById('sem').value = rec.inputs.sem;
      subjectSelect.value = rec.subject;
      updateTitle();
      historyModal.hide();
      calculateMarks();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteHistoryItem(id){
      if(!confirm('Delete this history item?')) return;
      state.history = state.history.filter(x => x.id !== id);
      localStorage.setItem('sx_calc_history', JSON.stringify(state.history));
      renderHistoryList();
    }

    document.getElementById('clearAllHistoryBtn').addEventListener('click', ()=>{
      if(!confirm('Clear all history?')) return;
      state.history = [];
      localStorage.removeItem('sx_calc_history');
      renderHistoryList();
    });

    // Export CSV
    document.getElementById('exportHistoryBtn').addEventListener('click', ()=>{
      if(state.history.length === 0){ alert('No history to export'); return; }
      const rows = [['time','subject','student','roll','finalTotal','a1','i1','a2','i2','sem']];
      state.history.forEach(h => {
        rows.push([
          h.time,
          h.subject,
          h.user ? h.user.name : '',
          h.user ? h.user.roll : '',
          format(h.outputs.finalTotal),
          h.inputs.a1, h.inputs.i1, h.inputs.a2, h.inputs.i2, h.inputs.sem
        ]);
      });
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'sxcc_calc_history.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ---------- Initialization ----------
    function init(){
      applyTheme();
      renderLoginArea();
      renderUserBadge();
      // default subject in title
      subjectTitle.innerHTML = `SXCCE <span style="margin-left:8px">CALC</span>`;
    }

    init();

    // expose some functions
    window.reapplyHistory = reapplyHistory;
    window.deleteHistoryItem = deleteHistoryItem;

  </script>
</body>
</html>